<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™åº«ç®¡ç†å¾Œå° (Debug)</title>
    <style>
        body { font-family: 'Segoe UI', monospace; padding: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 95%; margin: 0 auto; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card { background: white; padding: 25px; margin-bottom: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #e0e0e0; }
        
        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 25px; }
        h2 { color: #2980b9; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 20px; font-size: 14px; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; }
        th, td { border-bottom: 1px solid #dee2e6; padding: 12px 15px; text-align: left; vertical-align: top; }
        th { background-color: #f1f3f5; font-weight: 700; color: #495057; border-right: 1px solid #dee2e6; position: sticky; top: 0; z-index: 10; }
        td { border-right: 1px solid #dee2e6; }
        th:last-child, td:last-child { border-right: none; }
        
        /* æ¨™ç±¤èˆ‡æ–‡å­— */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; color: white; letter-spacing: 0.5px; }
        .badge-type { background-color: #17a2b8; }
        .badge-pk { background-color: #e74c3c; }
        
        .col-name { font-size: 1.1em; color: #2c3e50; font-weight: bold; }
        .section-title { font-weight: 800; margin: 20px 0 10px; color: #555; font-size: 1.1em; text-transform: uppercase; letter-spacing: 1px; }
        .empty-data { padding: 20px; text-align: center; color: #888; background: #f8f9fa; border-radius: 8px; border: 1px dashed #ced4da; }
        
        /* --- ç·¨è¼¯åŠŸèƒ½å°ˆç”¨æ¨£å¼ --- */
        
        /* å¯ç·¨è¼¯çš„å„²å­˜æ ¼ */
        td.editable {
            cursor: text;
            transition: all 0.2s;
            background-color: #fff;
        }
        td.editable:hover {
            background-color: #fff3cd; /* é»ƒè‰²é«˜äº®æç¤ºå¯ç·¨è¼¯ */
            box-shadow: inset 0 0 0 1px #ffc107;
        }
        td.editable:focus {
            background-color: #fff;
            outline: 2px solid #3498db;
            padding: 10px 13px; /* å¾®èª¿ä»¥é˜²æ­¢è·³å‹• */
            z-index: 2;
            position: relative;
        }

        /* ä¸»éµé–å®šæ¨£å¼ */
        td.pk-cell {
            background-color: #e9ecef;
            color: #6c757d;
            font-weight: bold;
            cursor: not-allowed;
            user-select: all; /* æ–¹ä¾¿è¤‡è£½ ID */
        }

        /* è³‡æ–™é è¦½é™åˆ¶ */
        .data-preview td { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .data-preview td:focus { white-space: normal; overflow: visible; max-width: none; } /* ç·¨è¼¯æ™‚å±•é–‹ */
        .data-preview th small { display: block; color: #6f42c1; font-weight: normal; margin-top: 4px; font-size: 0.85em; }

        /* ç‹€æ…‹ Toast */
        #toast {
            position: fixed; bottom: 30px; right: 30px;
            padding: 15px 25px; border-radius: 8px;
            color: white; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none; z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }
        .toast-loading { background-color: #17a2b8; }
        
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ› ï¸ è³‡æ–™åº«ç›´æ¥ç·¨è¼¯æ¨¡å¼</h1>
        <p>ğŸ’¡ <strong>æ“ä½œèªªæ˜ï¼š</strong> é»æ“Šä¸‹æ–¹ã€Œè³‡æ–™é è¦½ã€è¡¨æ ¼ä¸­çš„ä»»æ„å…§å®¹å³å¯ç›´æ¥ç·¨è¼¯ã€‚ç·¨è¼¯å®Œæˆå¾ŒæŒ‰ <strong>Enter</strong> æˆ–é»æ“Šç©ºç™½è™•å³å¯è‡ªå‹•å­˜æª”ã€‚</p>

        {% for table_name, info in db_info.items() %}
        <div class="card">
            <h2>ğŸ“¦ Table: {{ table_name }} <span style="font-size:0.6em; color:#888; margin-left:10px; font-weight:normal;">(PK: {{ info.pk_col }})</span></h2>
            
            <details>
                <summary class="section-title" style="cursor: pointer; display: inline-block;">ğŸ“‹ æª¢è¦–æ¬„ä½å®šç¾© (Schema)</summary>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th style="width: 200px;">æ¬„ä½åç¨±</th>
                            <th>ä¸­æ–‡èªªæ˜</th>
                            <th>å‹æ…‹</th>
                            <th>Null?</th>
                            <th>é è¨­å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for col in info.schema %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <div class="col-name">{{ col.name }}</div>
                                {% if col.name == info.pk_col %}<span class="badge badge-pk">PK</span>{% endif %}
                            </td>
                            <td><span style="color: #2c3e50;">{{ col.desc }}</span></td>
                            <td><span class="badge badge-type">{{ col.type }}</span></td>
                            <td>
                                {% if col.nullable == 'YES' %}<span style="color:#28a745;">âœ”</span>{% else %}<span style="color:#dc3545;">âœ–</span>{% endif %}
                            </td>
                            <td><code>{{ col.default or '-' }}</code></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </details>

            <div class="section-title" style="margin-top: 20px;">ğŸ” çœŸå¯¦è³‡æ–™é è¦½ & ç·¨è¼¯ (Top 50 Rows)</div>
            <div style="overflow-x: auto;">
                {% if info.data %}
                <table class="data-preview" 
                       data-table-name="{{ table_name }}" 
                       data-pk-name="{{ info.pk_col }}">
                    <thead>
                        <tr>
                            {% for col in info.schema %}
                            <th>
                                {{ col.name }}
                                <small>{{ col.desc }}</small>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in info.data %}
                        <tr>
                            {% for cell in row %}
                                {% set col_name = info.schema[loop.index0].name %}
                                
                                {% if col_name == info.pk_col %}
                                    <td class="pk-cell" 
                                        data-col-name="{{ col_name }}"
                                        title="ä¸»éµç„¡æ³•ä¿®æ”¹">
                                        {{ cell }}
                                    </td>
                                {% else %}
                                    <td class="editable" 
                                        contenteditable="true"
                                        data-col-name="{{ col_name }}"
                                        onblur="saveData(this)"
                                        onkeydown="handleEnter(event, this)">
                                        {{ cell if cell is not none else '' }}
                                    </td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-data">ğŸ“­ æ­¤è³‡æ–™è¡¨ç›®å‰æ²’æœ‰ä»»ä½•è³‡æ–™ã€‚</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="toast">å„²å­˜ä¸­...</div>

    <script>
        // è¨˜éŒ„ç·¨è¼¯å‰çš„å…§å®¹ï¼Œè‹¥æ²’è®Šæ›´å°±ä¸ç™¼é€è«‹æ±‚
        let originalContent = "";

        document.querySelectorAll('.editable').forEach(cell => {
            cell.addEventListener('focus', function() {
                originalContent = this.innerText;
            });
        });

        // æŒ‰ä¸‹ Enter æ™‚è§¸ç™¼å„²å­˜ (é˜²æ­¢æ›è¡Œ)
        function handleEnter(e, cell) {
            if (e.key === 'Enter') {
                e.preventDefault();
                cell.blur(); // è§¸ç™¼ onblur
            }
        }

        // æ ¸å¿ƒå„²å­˜åŠŸèƒ½
        function saveData(cell) {
            const newValue = cell.innerText;
            if (newValue === originalContent) return; // å…§å®¹æœªè®Šæ›´

            const tableEl = cell.closest('table');
            const rowEl = cell.parentElement;
            
            const tableName = tableEl.dataset.tableName;
            const pkName = tableEl.dataset.pkName;
            const colName = cell.dataset.colName;
            
            // æ‰¾å‡ºåŒä¸€åˆ—ä¸­çš„ PK å€¼
            // æˆ‘å€‘é€é data-col-name å±¬æ€§æ‰¾åˆ°è©²åˆ—å°æ‡‰ PK çš„é‚£å€‹ cell
            const pkCell = rowEl.querySelector(`td[data-col-name="${pkName}"]`);
            
            if (!pkCell) {
                showToast('âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¸»éµæ¬„ä½', 'toast-error');
                return;
            }
            
            const pkVal = pkCell.innerText.trim();

            showToast('ğŸ”„ å„²å­˜ä¸­...', 'toast-loading');

            fetch('/try/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table: tableName,
                    pk_col: pkName,
                    pk_val: pkVal,
                    column: colName,
                    value: newValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('âœ… æ›´æ–°æˆåŠŸ', 'toast-success');
                    cell.style.backgroundColor = '#d4edda'; // ç¶ è‰²é–ƒçˆ
                    setTimeout(() => cell.style.backgroundColor = '', 1000);
                    originalContent = newValue; // æ›´æ–°æš«å­˜
                } else {
                    showToast('âŒ æ›´æ–°å¤±æ•—: ' + data.error, 'toast-error');
                    cell.innerText = originalContent; // é‚„åŸæ•¸å€¼
                }
            })
            .catch(err => {
                console.error(err);
                showToast('âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤', 'toast-error');
                cell.innerText = originalContent;
            });
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = type;
            toast.style.display = 'block';

            if (type !== 'toast-loading') {
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 2000);
            }
        }
    </script>
</body>
</html>
