
<!DOCTYPE html>
<html lang="{{ display_lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ texts['title'] }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding-bottom: 160px; background: #f8f9fa; touch-action: manipulation; font-size: 18px; }
        .header { background: white; padding: 15px; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cat-bar { display: flex; overflow-x: auto; white-space: nowrap; padding: 10px 0; gap: 10px; scrollbar-width: none; }
        .cat-bar::-webkit-scrollbar { display: none; }
        .cat-btn { background: #f1f3f5; border: 1px solid #dee2e6; padding: 8px 18px; border-radius: 25px; font-size: 1em; color: #495057; cursor: pointer; }
        .cat-btn.active { background: #28a745; color: white; border-color: #28a745; }
        .menu-item { background: white; margin: 12px; padding: 15px; border-radius: 12px; display: flex; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; }
        .menu-img { width: 100px; height: 100px; border-radius: 10px; object-fit: cover; background: #eee; }
        .menu-info { flex: 1; padding-left: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        .add-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 20px; align-self: flex-end; font-size: 1em; font-weight: bold; }
        .sold-out { filter: grayscale(1); opacity: 0.6; pointer-events: none; }
        .sold-out-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 5px; font-size: 0.9em; font-weight: bold; z-index: 5; }
        .cart-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); display: none; flex-direction: column; box-sizing: border-box; z-index: 100; }
        .cart-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cart-buttons { display: flex; gap: 12px; }
        .btn-view-cart { background: #ff9800; color: white; border: none; flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.2em; }
        .btn-checkout { background: #28a745; color: white; border: none; flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.2em; }
        
        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 200; justify-content: center; align-items: flex-end; }
        .modal-c { background: white; width: 100%; padding: 25px; border-radius: 25px 25px 0 0; max-height: 85vh; overflow-y: auto; box-sizing: border-box; }
        .opt-tag { border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px; margin: 5px; display: inline-block; font-size: 1.1em; }
        .opt-tag.sel { background: #e3f2fd; border-color: #2196f3; color: #2196f3; font-weight: bold; }
        .qty-ctrl { display: flex; align-items: center; gap: 15px; justify-content: center; margin: 20px 0; }
        .qty-ctrl button { width: 50px; height: 50px; border-radius: 25px; border: 1px solid #ddd; background: white; font-size: 1.8em; }
        .qty-input { width: 70px; text-align: center; font-size: 1.4em; border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        .cat-header { padding: 12px 15px; font-weight: bold; font-size: 1.3em; color: #333; background: #eee; margin-top: 15px; scroll-margin-top: 160px; }

        /* å¤–é€è³‡è¨Šå¡ç‰‡æ¨£å¼ */
        .delivery-info-card {
            background: #e3f2fd; border: 1px solid #90caf9; border-radius: 10px; padding: 12px; margin-bottom: 10px; color: #1565c0; font-size: 0.95em;
        }
        .di-row { margin-bottom: 4px; display: flex; align-items: flex-start; }
        .di-icon { margin-right: 8px; font-size: 1.1em; }
        .di-fee { font-weight: bold; color: #d32f2f; margin-top: 5px; text-align: right; border-top: 1px solid #bbdefb; padding-top: 5px; }

        /* è³¼ç‰©è»Šæ¨£å¼èª¿æ•´ */
        .cart-item-row { border-bottom: 1px solid #eee; padding: 15px 0; }
        .cart-item-main { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cart-qty-sub { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
        .btn-edit-opt { background: #e3f2fd; color: #2196f3; border: 1px solid #2196f3; padding: 6px 12px; border-radius: 8px; font-size: 0.9em; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    {# --- 1. å¼·åˆ¶å¾ Session è®€å–è³‡æ–™ --- #}
    {% set session_delivery = session.get('delivery_data', {}) %}
    {% set session_table = session.get('table_num') %}
    
    {# --- 2. åˆ¤æ–·é‚è¼¯ï¼šåªè¦ Session è£¡æœ‰é›»è©±ï¼Œæˆ–æ¡Œè™Ÿæ˜¯å¤–é€ï¼Œå°±èªå®šç‚ºå¤–é€æ¨¡å¼ --- #}
    {% set is_delivery_mode = (session_delivery.get('phone')) or (session_table == 'å¤–é€') %}
    
    {# --- 3. æ±ºå®šæœ€çµ‚é¡¯ç¤ºçš„æ¡Œè™Ÿ (å¦‚æœæ˜¯å¤–é€æ¨¡å¼ï¼Œå¼·åˆ¶é¡¯ç¤º 'å¤–é€') --- #}
    {% set final_table_num = 'å¤–é€' if is_delivery_mode else (table_num or session_table or '') %}

    <div class="header">
        {% if edit_oid %}
        <div style="background:#fff3cd;padding:12px;color:#856404;text-align:center;font-weight:bold;margin-bottom:10px;border-radius:8px;">
            âš ï¸ {{ texts['edit_notice'] or 'æ­£åœ¨ç·¨è¼¯' }} #{{ edit_oid }} ({{ order_lang }})
        </div>
        {% endif %}
        
        <h2 style="margin:0 0 10px 0;">{{ texts['welcome'] }}</h2>

        {% if is_delivery_mode %}
            {# --- å¤–é€æ¨¡å¼é¡¯ç¤ºå¡ç‰‡ --- #}
            <div class="delivery-info-card">
                <div class="di-row"><span class="di-icon">ğŸ›µ</span> <b>å¤–é€è¨‚å–® (Delivery)</b></div>
                <div class="di-row"><span class="di-icon">ğŸ‘¤</span> {{ session_delivery.get('name', 'è²´è³“') }} / {{ session_delivery.get('phone', '-') }}</div>
                <div class="di-row"><span class="di-icon">ğŸ“</span> {{ session_delivery.get('address', 'åœ°å€è¼‰å…¥ä¸­') }}</div>
                <div class="di-fee">
                    é‹è²» Delivery Fee: ${{ session.get('delivery_info', {}).get('shipping_fee', 0) }}
                    {% if session.get('delivery_info', {}).get('note') %}
                        <br><small style="color:#666;font-weight:normal;">{{ session.get('delivery_info', {}).get('note') }}</small>
                    {% endif %}
                </div>
            </div>
            
            {# --- é–å®šçš„å¤–é€æ¡Œè™Ÿæ¬„ä½ (å”¯è®€) --- #}
            <div style="margin-bottom: 10px;">
                <label style="font-weight:bold; color:#1565c0;">{{ texts['table_placeholder'] }}</label>
                <input type="text" id="visible_table" value="å¤–é€" readonly
                       style="padding:12px;width:100%;box-sizing:border-box;border:2px solid #90caf9; background:#e3f2fd; color:#1565c0; border-radius:8px;font-size:1.2em;margin-top:5px; text-align:center; font-weight:bold;">
            </div>
        {% else %}
            {# --- å…§ç”¨æ¨¡å¼ --- #}
            <div style="margin-bottom: 10px;">
                <label style="font-weight:bold; color:#555;">{{ texts['table_placeholder'] }}</label>
                <input type="text" id="visible_table" value="{{ final_table_num }}" placeholder="è«‹è¼¸å…¥æ¡Œè™Ÿ" 
                       style="padding:12px;width:100%;box-sizing:border-box;border:2px solid #ddd;border-radius:8px;font-size:1.2em;margin-top:5px;">
            </div>
        {% endif %}

        <div class="cat-bar" id="cat-nav"></div>
    </div>

    <div id="list"></div>

    <form id="order-form" method="POST" action="/menu">
        <input type="hidden" name="cart_data" id="cart_input">
        <input type="hidden" name="lang_input" id="lang_final_input" value="{{ order_lang }}">
        {% if edit_oid %}
        <input type="hidden" name="old_order_id" value="{{ edit_oid }}">
        {% endif %}
        
        {# --- é€™è£¡å°æ‡‰ database.py çš„ orders è¡¨ table_number æ¬„ä½ --- #}
        <input type="hidden" name="table_number" id="tbl_input">
        
        {# --- å¤–é€è³‡æ–™æ¬„ä½ (åç¨±å·²å°æ‡‰ database.py æ¬„ä½) --- #}
        <input type="hidden" name="order_type" value="{{ 'delivery' if is_delivery_mode else 'dine_in' }}">
        <input type="hidden" name="customer_name" value="{{ session_delivery.get('name', '') }}">
        <input type="hidden" name="customer_phone" value="{{ session_delivery.get('phone', '') }}">
        
        {# --- ä¿®æ­£ï¼šé€™è£¡æ”¹æˆ customer_address ä»¥å°æ‡‰ database.py --- #}
        <input type="hidden" name="customer_address" value="{{ session_delivery.get('address', '') }}">
        
        <input type="hidden" name="delivery_fee" value="{{ session.get('delivery_info', {}).get('shipping_fee', 0) }}">
        
        <div class="cart-bar" id="bar">
            <div class="cart-summary">
                <div style="font-weight:bold; font-size:1.3em;">Total: $<span id="tot">0</span> (<span id="cnt">0</span>)</div>
                <label style="font-size:1em;"><input type="checkbox" name="need_receipt" checked> {{ texts['print_receipt_opt'] }}</label>
            </div>
            <div class="cart-buttons">
                <button type="button" class="btn-view-cart" onclick="showCart()">ğŸ›’ {{ texts['cart_detail'] }}</button>
                <button type="button" class="btn-checkout" onclick="sub()">{{ texts['checkout'] }}</button>
            </div>
        </div>
    </form>

    {# --- Modal å€åŸŸ --- #}
    <div class="modal" id="opt-m" onclick="closeModalByBg(event, 'opt-m')">
        <div class="modal-c" onclick="event.stopPropagation()">
            <h3 id="m-name" style="font-size:1.5em;margin-top:0;"></h3>
            <div id="m-opts"></div>
            <div class="qty-ctrl">
                <button onclick="cq(-1)">-</button>
                <input type="number" id="m-q" class="qty-input" value="1" min="1" inputmode="numeric">
                <button onclick="cq(1)">+</button>
            </div>
            <button id="m-confirm-btn" onclick="addC()" style="width:100%;background:#28a745;color:white;padding:18px;border:none;border-radius:15px;margin-top:10px;font-size:1.3em;font-weight:bold;">{{ texts['modal_add_cart'] }}</button>
            <button onclick="document.getElementById('opt-m').style.display='none'" style="width:100%;background:white;padding:12px;border:none;margin-top:10px;font-size:1.1em;color:#666;">{{ texts['modal_cancel'] }}</button>
        </div>
    </div>

    <div class="modal" id="cart-m" onclick="closeModalByBg(event, 'cart-m')">
        <div class="modal-c" onclick="event.stopPropagation()">
            <h2 style="margin-top:0;">{{ texts['cart_title'] }}</h2>
            <div id="c-list"></div>
            <button onclick="document.getElementById('cart-m').style.display='none'" style="width:100%;padding:15px;margin-top:20px;border:1px solid #ddd;border-radius:12px;background:#f8f9fa;font-size:1.1em;">{{ texts['close'] }}</button>
        </div>
    </div>

    <script>
    const P = {{ products | tojson }};
    const T = {{ texts | tojson }};
    const EDIT_OID = "{{ edit_oid or '' }}";
    const PRELOAD_CART = {{ preload_cart | safe }};
    const CUR_LANG = "{{ display_lang }}";
    
    // JS é€™è£¡ä¹Ÿæ”¹ç‚ºä½¿ç”¨è®Šæ•¸åˆ¤å®š
    const IS_DELIVERY = {{ 'true' if is_delivery_mode else 'false' }};
    const DELIVERY_FEE = {{ session.get('delivery_info', {}).get('shipping_fee', 0) }};

    let C = [], cur = null, selectedOptIndices = [], addP = 0, editIndex = -1;

    function saveCache() { 
        if(!EDIT_OID) localStorage.setItem('cart_cache', JSON.stringify(C)); 
    }

    function initCart() {
        if(EDIT_OID && PRELOAD_CART) {
            C = PRELOAD_CART;
        } else {
            let cached = localStorage.getItem('cart_cache');
            C = cached ? JSON.parse(cached) : [];
        }
        upd();
    }

    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (C.length > 0 && !localStorage.getItem('cart_cache') && !EDIT_OID)) {
            initCart();
        }
    });

    let h = "", lastCatKey = "", cats = [];
    P.forEach(p => {
        let currentCatName = p['category_' + CUR_LANG] || p.category_zh;
        let catId = "cat-" + p.category_zh.replace(/\s+/g, '-'); 
        if(p.category_zh != lastCatKey) { 
            h += `<div class="cat-header" id="${catId}">${currentCatName}</div>`; 
            lastCatKey = p.category_zh; 
            cats.push({ id: catId, name: currentCatName });
        }
        let isAvail = p.is_available;
        let d_name = p['name_' + CUR_LANG] || p.name_zh;
        h += `<div class="menu-item ${isAvail ? '' : 'sold-out'}">
            ${isAvail ? '' : `<div class="sold-out-badge">${T.sold_out}</div>`}
            ${p.image_url ? `<img src="${p.image_url}" class="menu-img">` : ''}
            <div class="menu-info">
                <div><b>${d_name}</b><div style="color:#e91e63; font-weight:bold; font-size:1.1em;">$${p.price}</div></div>
                <button class="add-btn" onclick="openOpt(${p.id})" ${isAvail ? '' : 'disabled'}>${isAvail ? T.add : T.sold_out}</button>
            </div>
        </div>`;
    });
    document.getElementById('list').innerHTML = h;

    let navH = ""; 
    cats.forEach(c => { 
        navH += `<div class="cat-btn" onclick="scrollToCat('${c.id}', this)">${c.name}</div>`; 
    });
    document.getElementById('cat-nav').innerHTML = navH;

    function scrollToCat(catId, btn) {
        const el = document.getElementById(catId);
        if(el) {
            const offset = 160;
            const bodyRect = document.body.getBoundingClientRect().top;
            const elementRect = el.getBoundingClientRect().top;
            const elementPosition = elementRect - bodyRect;
            const offsetPosition = elementPosition - offset;
            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    }

    function closeModalByBg(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }

    function openOpt(productId, cartIndex = -1) {
        cur = P.find(x => x.id == productId); 
        editIndex = cartIndex;
        selectedOptIndices = []; 
        addP = 0;
        
        document.getElementById('m-name').innerText = (editIndex > -1 ? "âœï¸ " : "") + (cur['name_' + CUR_LANG] || cur.name_zh);
        document.getElementById('m-confirm-btn').innerText = editIndex > -1 ? (T.save_changes || "ğŸ’¾ å„²å­˜ä¿®æ”¹") : T.modal_add_cart;
        
        let area = document.getElementById('m-opts'); 
        area.innerHTML = "";
        
        let opts = cur['custom_options_' + CUR_LANG] || cur.custom_options_zh;
        if (typeof opts === 'string') {
            opts = opts.split(',').filter(x => x.trim() !== '');
        } else if (!Array.isArray(opts)) {
            opts = [];
        }

        let existingOpts = editIndex > -1 ? C[editIndex].options_zh : [];
        
        opts.forEach((o, index) => {
            let parts = o.split(/[+]/); 
            let n = parts[0].trim(), p = parts.length > 1 ? parseInt(parts[1]) : 0;
            let d = document.createElement('div'); 
            d.className = 'opt-tag';
            d.innerText = n + (p ? ` (+$${p})` : '');
            
            if(editIndex > -1 && existingOpts.includes(n)) { 
                selectedOptIndices.push(index); 
                addP += p; 
                d.classList.add('sel');
            }
            
            d.onclick = () => {
                if(selectedOptIndices.includes(index)) {
                    selectedOptIndices = selectedOptIndices.filter(i => i != index); 
                    addP -= p; 
                    d.classList.remove('sel');
                } else {
                    selectedOptIndices.push(index); 
                    addP += p; 
                    d.classList.add('sel');
                }
            };
            area.appendChild(d);
        });
        
        document.getElementById('m-q').value = editIndex > -1 ? C[editIndex].qty : 1;
        document.getElementById('opt-m').style.display = 'flex';
        document.getElementById('cart-m').style.display = 'none';
    }

    function cq(n) {
        let input = document.getElementById('m-q'); 
        let val = parseInt(input.value) || 1;
        if(val + n >= 1) input.value = val + n;
    }

    function addC() {
        let q = parseInt(document.getElementById('m-q').value) || 1;
        
        let opts_zh = cur.custom_options_zh || [];
        if(typeof opts_zh === 'string') opts_zh = opts_zh.split(',').filter(x=>x);
        
        let opts_en = cur.custom_options_en || opts_zh;
        if(typeof opts_en === 'string') opts_en = opts_en.split(',').filter(x=>x);

        let opts_jp = cur.custom_options_jp || opts_zh;
        if(typeof opts_jp === 'string') opts_jp = opts_jp.split(',').filter(x=>x);

        let opts_kr = cur.custom_options_kr || opts_zh;
        if(typeof opts_kr === 'string') opts_kr = opts_kr.split(',').filter(x=>x);

        let itemData = { 
            id: cur.id, 
            name_zh: cur.name_zh, name_en: cur.name_en, name_jp: cur.name_jp, name_kr: cur.name_kr, 
            unit_price: cur.price + addP, 
            qty: q, 
            options_zh: selectedOptIndices.map(idx => (opts_zh[idx] || '').split('+')[0].trim()),
            options_en: selectedOptIndices.map(idx => (opts_en[idx] || opts_zh[idx] || '').split('+')[0].trim()),
            options_jp: selectedOptIndices.map(idx => (opts_jp[idx] || opts_zh[idx] || '').split('+')[0].trim()),
            options_kr: selectedOptIndices.map(idx => (opts_kr[idx] || opts_zh[idx] || '').split('+')[0].trim()),
            category: cur.category_zh, 
            print_category: cur.print_category 
        };
        
        if(editIndex > -1) C[editIndex] = itemData; else C.push(itemData);
        
        document.getElementById('opt-m').style.display = 'none'; 
        saveCache(); 
        upd(); 
        if(editIndex > -1) showCart();
    }

    function upd() {
        if(C.length) {
            document.getElementById('bar').style.display = 'flex';
            let foodTotal = C.reduce((a, b) => a + b.unit_price * b.qty, 0);
            let finalTotal = foodTotal;
            if (IS_DELIVERY) {
                finalTotal += DELIVERY_FEE;
            }
            document.getElementById('tot').innerText = finalTotal;
            document.getElementById('cnt').innerText = C.reduce((a, b) => a + b.qty, 0);
        } else {
            document.getElementById('bar').style.display = 'none';
        }
    }

    function updateCartQty(idx, n) {
        C[idx].qty += n; 
        if(C[idx].qty <= 0) C.splice(idx, 1);
        saveCache(); 
        showCart(); 
        upd();
    }

    function showCart() {
        let h = "";
        C.forEach((i, x) => {
            let d_name = i['name_' + CUR_LANG] || i.name_zh;
            let opts = i['options_' + CUR_LANG] || i.options_zh || [];
            let opt_str = opts.length ? `<div style="font-size:0.9em;color:#666;margin-top:4px;">(${opts.join(',')})</div>` : '';
            h += `<div class="cart-item-row">
                <div class="cart-item-main">
                    <div style="flex:1;"><b style="font-size:1.15em;">${d_name}</b>${opt_str}</div>
                    <div style="font-weight:bold;color:#e91e63;font-size:1.1em;margin-left:10px;">$${i.unit_price * i.qty}</div>
                </div>
                <div class="cart-qty-sub">
                    <button onclick="if(confirm('${T.confirm_delete || 'Delete?'}')){C.splice(${x},1);saveCache();upd();showCart();}" style="border:1px solid #ffcdd2; background:#fff5f5; border-radius:8px; padding:6px 10px; cursor:pointer; margin-right:auto;">ğŸ—‘ï¸</button>
                    <button class="btn-edit-opt" onclick="openOpt(${i.id}, ${x})">${T.edit_options || 'Edit'}</button>
                    <div class="qty-ctrl" style="margin:0; gap:8px;">
                        <button onclick="updateCartQty(${x}, -1)" style="width:36px;height:36px;font-size:1.2em;">-</button>
                        <span style="min-width:30px;text-align:center;font-weight:bold;">${i.qty}</span>
                        <button onclick="updateCartQty(${x}, 1)" style="width:36px;height:36px;font-size:1.2em;">+</button>
                    </div>
                </div>
            </div>`;
        });
        
        if (IS_DELIVERY && C.length > 0) {
            h += `<div style="text-align:right; padding:15px 0; border-top:2px solid #333; color:#1565c0; font-weight:bold;">
                    Delivery Fee (é‹è²»): $${DELIVERY_FEE}
                  </div>`;
        }

        document.getElementById('c-list').innerHTML = h || `<p style="text-align:center;">${T.empty_cart}</p>`;
        document.getElementById('cart-m').style.display = 'flex';
    }

    function sub() {
        // --- 1. å¤–é€ä½æ¶ˆæª¢æŸ¥ ---
        if (IS_DELIVERY) {
            let foodTotal = C.reduce((a, b) => a + (b.unit_price * b.qty), 0);
            if (foodTotal < 1000) {
                alert("âš ï¸ å¤–é€è¨‚å–®é‡‘é¡æœªæ»¿ $1000 å…ƒ (ä¸å«é‹è²»)\nè«‹å†åŠ é»å•†å“ã€‚\n\nMinimum order for delivery is $1000.");
                return; 
            }
        }

        // --- 2. æ±ºå®šæ¡Œè™Ÿ (é—œéµä¿®æ”¹) ---
        let tableVal = document.getElementById('visible_table').value;
        
        if (IS_DELIVERY) {
            // å¼·åˆ¶è¨­å®šç‚º 'å¤–é€'ï¼Œç¢ºä¿å‚³å…¥ database.py orders è¡¨çš„ table_number æ¬„ä½æ˜¯æ­£ç¢ºçš„å­—ä¸²
            tableVal = 'å¤–é€';
        }

        if(!tableVal || tableVal.trim() === '') {
            return alert(T.table_placeholder || 'è«‹è¼¸å…¥æ¡Œè™Ÿ');
        }
        
        // å¡«å…¥ hidden input (name="table_number")
        document.getElementById('tbl_input').value = tableVal;

        if(confirm(T.confirm_order)) {
            document.getElementById('cart_input').value = JSON.stringify(C);
            localStorage.removeItem('cart_cache');
            document.getElementById('order-form').submit();
        }
    }
    
    initCart();
    </script>
</body>
</html>
