<!DOCTYPE html>
<html lang="{{ display_lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ texts['title'] }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding-bottom: 160px; background: #f8f9fa; touch-action: manipulation; font-size: 18px; }
        .header { background: white; padding: 15px; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cat-bar { display: flex; overflow-x: auto; white-space: nowrap; padding: 10px 0; gap: 10px; scrollbar-width: none; }
        .cat-bar::-webkit-scrollbar { display: none; }
        .cat-btn { background: #f1f3f5; border: 1px solid #dee2e6; padding: 8px 18px; border-radius: 25px; font-size: 1em; color: #495057; cursor: pointer; }
        .cat-btn.active { background: #28a745; color: white; border-color: #28a745; }
        .menu-item { background: white; margin: 12px; padding: 15px; border-radius: 12px; display: flex; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; }
        .menu-img { width: 100px; height: 100px; border-radius: 10px; object-fit: cover; background: #eee; }
        .menu-info { flex: 1; padding-left: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        .add-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 20px; align-self: flex-end; font-size: 1em; font-weight: bold; }
        .sold-out { filter: grayscale(1); opacity: 0.6; pointer-events: none; }
        .sold-out-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 5px; font-size: 0.9em; font-weight: bold; z-index: 5; }
        .cart-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); display: none; flex-direction: column; box-sizing: border-box; z-index: 100; }
        .cart-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cart-buttons { display: flex; gap: 12px; }
        .btn-view-cart { background: #ff9800; color: white; border: none; flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.2em; }
        .btn-checkout { background: #28a745; color: white; border: none; flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.2em; }
        
        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 200; justify-content: center; align-items: flex-end; }
        .modal-c { background: white; width: 100%; padding: 25px; border-radius: 25px 25px 0 0; max-height: 85vh; overflow-y: auto; box-sizing: border-box; }
        .opt-tag { border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px; margin: 5px; display: inline-block; font-size: 1.1em; }
        .opt-tag.sel { background: #e3f2fd; border-color: #2196f3; color: #2196f3; font-weight: bold; }
        .qty-ctrl { display: flex; align-items: center; gap: 15px; justify-content: center; margin: 20px 0; }
        .qty-ctrl button { width: 50px; height: 50px; border-radius: 25px; border: 1px solid #ddd; background: white; font-size: 1.8em; }
        .qty-input { width: 70px; text-align: center; font-size: 1.4em; border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        .cat-header { padding: 12px 15px; font-weight: bold; font-size: 1.3em; color: #333; background: #eee; margin-top: 15px; scroll-margin-top: 160px; }

        /* Delivery Info Card */
        .delivery-info-card { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 10px; padding: 12px; margin-bottom: 10px; color: #1565c0; font-size: 0.95em; }
        .di-row { margin-bottom: 4px; display: flex; align-items: flex-start; }
        .di-icon { margin-right: 8px; font-size: 1.1em; }
        .di-fee { font-weight: bold; color: #d32f2f; margin-top: 5px; text-align: right; border-top: 1px solid #bbdefb; padding-top: 5px; }

        /* Cart Adjustment */
        .cart-item-row { border-bottom: 1px solid #eee; padding: 15px 0; }
        .cart-item-main { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cart-qty-sub { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
        .btn-edit-opt { background: #e3f2fd; color: #2196f3; border: 1px solid #2196f3; padding: 6px 12px; border-radius: 8px; font-size: 0.9em; font-weight: bold; cursor: pointer; }

        /* Mode Switching */
        .mode-switch { display: flex; background: #eee; border-radius: 10px; padding: 4px; margin-bottom: 10px; }
        .mode-opt { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold; color: #666; }
        .mode-opt.active { background: white; color: #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .takeout-time-box { margin-top: 10px; background: #fff3cd; padding: 10px; border-radius: 8px; border: 1px solid #ffeeba; }
        .time-picker { width: 100%; padding: 10px; font-size: 1.2em; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; box-sizing: border-box; }
    </style>
</head>
<body>
    {# --- å¾ Session è®€å–ç‹€æ…‹ --- #}
    {% set session_delivery = session.get('delivery_data', {}) %}
    {% set session_table = session.get('table_num') %}
    
    {# --- åˆ¤æ–·æ¨¡å¼ï¼šå¤–é€æ¨¡å¼å„ªå…ˆ --- #}
    {% set is_delivery_mode = (session_delivery.get('phone')) or (session_table == 'å¤–é€') %}
    {% set final_table_num = 'å¤–é€' if is_delivery_mode else (table_num or session_table or '') %}

    <div class="header">
        {% if edit_oid %}
        <div style="background:#fff3cd;padding:12px;color:#856404;text-align:center;font-weight:bold;margin-bottom:10px;border-radius:8px;">
            âš ï¸ {{ texts['edit_notice'] or 'æ­£åœ¨ç·¨è¼¯' }} #{{ edit_oid }} ({{ order_lang }})
        </div>
        {% endif %}
        
        <h2 style="margin:0 0 10px 0;">{{ texts['welcome'] }}</h2>

        {# --- é ‚éƒ¨è¼¸å…¥å€ï¼šä¾æ¨¡å¼åˆ‡æ› --- #}
        {% if is_delivery_mode %}
            <div style="margin-bottom: 10px;">
                <label style="font-weight:bold; color:#1565c0;">{{ texts['table_placeholder'] }}</label>
                <input type="text" id="visible_table" value="å¤–é€" readonly
                       style="padding:12px;width:100%;box-sizing:border-box;border:2px solid #90caf9; background:#e3f2fd; color:#1565c0; border-radius:8px;font-size:1.2em;margin-top:5px; text-align:center; font-weight:bold;">
            </div>
        {% else %}
            <div style="margin-bottom: 10px;">
                <div class="mode-switch">
                    <div class="mode-opt active" id="mode-dinein" onclick="setMode('dinein')">ğŸ½ï¸ {{ texts['mode_dinein'] or 'ç¾å ´å…§ç”¨' }}</div>
                    <div class="mode-opt" id="mode-takeout" onclick="setMode('takeout')">ğŸ›ï¸ {{ texts['mode_takeout'] or 'é ç´„è‡ªå–' }}</div>
                </div>

                <div id="sec-dinein">
                    <label style="font-weight:bold; color:#555;">{{ texts['table_placeholder'] }}</label>
                    <input type="text" id="visible_table" value="{{ final_table_num }}" placeholder="è«‹è¼¸å…¥æ¡Œè™Ÿ" 
                           style="padding:12px;width:100%;box-sizing:border-box;border:2px solid #ddd;border-radius:8px;font-size:1.2em;margin-top:5px;">
                </div>

                <div id="sec-takeout" style="display: none;">
                    <div class="takeout-time-box">
                        <label style="font-weight:bold; color:#856404;">ğŸ•’ {{ texts['pickup_time_label'] or 'é è¨ˆå–é¤æ™‚é–“' }}</label>
                        <input type="datetime-local" id="takeout_time" class="time-picker">
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="cat-bar" id="cat-nav"></div>
    </div>

    {# --- å¤–é€è³‡è¨Šå¡ç‰‡ --- #}
    {% if is_delivery_mode %}
    <div style="padding: 10px 12px 0 12px;">
        <div class="delivery-info-card">
            <div class="di-row"><span class="di-icon">ğŸ›µ</span> <b>å¤–é€è¨‚å–® (Delivery)</b></div>
            <div class="di-row"><span class="di-icon">ğŸ‘¤</span> {{ session_delivery.get('name', 'è²´è³“') }} / {{ session_delivery.get('phone', '-') }}</div>
            <div class="di-row"><span class="di-icon">ğŸ“</span> {{ session_delivery.get('address', 'åœ°å€è¼‰å…¥ä¸­') }}</div>
            <div class="di-row"><span class="di-icon">ğŸ•’</span> é ç´„æ™‚é–“: {{ session_delivery.get('scheduled_for', 'ç›¡å¿«é€é”') }}</div>
            <div class="di-fee">é‹è²» Delivery Fee: ${{ session.get('delivery_info', {}).get('shipping_fee', 0) }}</div>
        </div>
    </div>
    {% endif %}

    <div id="list"></div>

    {# --- è¨‚å–®æäº¤ Form --- #}
    <form id="order-form" method="POST" action="/menu">
        <input type="hidden" name="cart_data" id="cart_input">
        <input type="hidden" name="lang_input" id="lang_final_input" value="{{ order_lang }}">
        {% if edit_oid %}<input type="hidden" name="old_order_id" value="{{ edit_oid }}">{% endif %}
        
        <input type="hidden" name="table_number" id="tbl_input">
        <input type="hidden" name="order_type" id="type_input" value="{{ 'delivery' if is_delivery_mode else 'dine_in' }}">
        
        {# å¤–é€å°ˆç”¨æ¬„ä½ #}
        <input type="hidden" name="customer_name" value="{{ session_delivery.get('name', '') }}">
        <input type="hidden" name="customer_phone" value="{{ session_delivery.get('phone', '') }}">
        <input type="hidden" name="delivery_address" value="{{ session_delivery.get('address', '') }}">
        <input type="hidden" name="delivery_note" value="{{ session_delivery.get('note', '') }}">
        <input type="hidden" name="scheduled_for" id="scheduled_for_input" value="{{ session_delivery.get('scheduled_for', '') }}">
        <input type="hidden" name="delivery_fee" value="{{ session.get('delivery_info', {}).get('shipping_fee', 0) }}">
        
        <div class="cart-bar" id="bar">
            <div class="cart-summary">
                <div style="font-weight:bold; font-size:1.3em;">Total: $<span id="tot">0</span> (<span id="cnt">0</span>)</div>
                <label style="font-size:1em;"><input type="checkbox" name="need_receipt" checked> {{ texts['print_receipt_opt'] }}</label>
            </div>
            <div class="cart-buttons">
                <button type="button" class="btn-view-cart" onclick="showCart()">ğŸ›’ {{ texts['cart_detail'] }}</button>
                <button type="button" class="btn-checkout" onclick="sub()">{{ texts['checkout'] }}</button>
            </div>
        </div>
    </form>

    {# --- Modals --- #}
    <div class="modal" id="opt-m" onclick="closeModalByBg(event, 'opt-m')">
        <div class="modal-c" onclick="event.stopPropagation()">
            <h3 id="m-name" style="font-size:1.5em;margin-top:0;"></h3>
            <div id="m-opts"></div>
            <div class="qty-ctrl">
                <button onclick="cq(-1)">-</button>
                <input type="number" id="m-q" class="qty-input" value="1" min="1" inputmode="numeric">
                <button onclick="cq(1)">+</button>
            </div>
            <button id="m-confirm-btn" onclick="addC()" style="width:100%;background:#28a745;color:white;padding:18px;border:none;border-radius:15px;margin-top:10px;font-size:1.3em;font-weight:bold;">{{ texts['modal_add_cart'] }}</button>
            <button onclick="document.getElementById('opt-m').style.display='none'" style="width:100%;background:white;padding:12px;border:none;margin-top:10px;font-size:1.1em;color:#666;">{{ texts['modal_cancel'] }}</button>
        </div>
    </div>

    <div class="modal" id="cart-m" onclick="closeModalByBg(event, 'cart-m')">
        <div class="modal-c" onclick="event.stopPropagation()">
            <h2 style="margin-top:0;">{{ texts['cart_title'] }}</h2>
            <div id="c-list"></div>
            <button onclick="document.getElementById('cart-m').style.display='none'" style="width:100%;padding:15px;margin-top:20px;border:1px solid #ddd;border-radius:12px;background:#f8f9fa;font-size:1.1em;">{{ texts['close'] }}</button>
        </div>
    </div>

    <script>
    const P = {{ products | tojson }};
    const T = {{ texts | tojson }};
    const EDIT_OID = "{{ edit_oid or '' }}";
    const PRELOAD_CART = {{ preload_cart | safe }};
    const CUR_LANG = "{{ display_lang }}";
    const IS_DELIVERY = {{ 'true' if is_delivery_mode else 'false' }};
    const DELIVERY_FEE = {{ session.get('delivery_info', {}).get('shipping_fee', 0) }};
    const DELIVERY_MIN = {{ session.get('delivery_info', {}).get('min_price', 500) }};

    let C = [], cur = null, selectedOptIndices = [], addP = 0, editIndex = -1;
    let currentMode = 'dinein';

    function setMode(mode) {
        if(IS_DELIVERY) return;
        currentMode = mode;
        document.querySelectorAll('.mode-opt').forEach(el => el.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.add('active');
        document.getElementById('type_input').value = (mode === 'dinein' ? 'dine_in' : 'takeout');

        if(mode === 'dinein') {
            document.getElementById('sec-dinein').style.display = 'block';
            document.getElementById('sec-takeout').style.display = 'none';
        } else {
            document.getElementById('sec-dinein').style.display = 'none';
            document.getElementById('sec-takeout').style.display = 'block';
            initTimePicker();
        }
    }

    function initTimePicker() {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 20); // é è¨­ 20 åˆ†é˜å¾Œå–é¤
        const offset = now.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
        const picker = document.getElementById('takeout_time');
        if(!picker.value) picker.value = localISOTime;
    }

    function saveCache() { if(!EDIT_OID) localStorage.setItem('cart_cache', JSON.stringify(C)); }

    function initCart() {
        if(EDIT_OID && PRELOAD_CART) { C = PRELOAD_CART; } 
        else {
            let cached = localStorage.getItem('cart_cache');
            C = cached ? JSON.parse(cached) : [];
        }
        upd();
    }

    // æ¸²æŸ“æ¸…å–®
    let h = "", lastCat = "", cats = [];
    P.forEach(p => {
        let curCat = p['category_' + CUR_LANG] || p.category_zh;
        if(p.category_zh != lastCat) {
            let cid = "cat-" + p.category_zh.replace(/\s+/g, '-');
            h += `<div class="cat-header" id="${cid}">${curCat}</div>`;
            lastCat = p.category_zh;
            cats.push({id: cid, name: curCat});
        }
        let isAvail = p.is_available;
        h += `<div class="menu-item ${isAvail ? '' : 'sold-out'}">
            ${isAvail ? '' : `<div class="sold-out-badge">${T.sold_out}</div>`}
            ${p.image_url ? `<img src="${p.image_url}" class="menu-img">` : ''}
            <div class="menu-info">
                <div><b>${p['name_'+CUR_LANG] || p.name_zh}</b><div style="color:#e91e63; font-weight:bold;">$${p.price}</div></div>
                <button class="add-btn" onclick="openOpt(${p.id})">${isAvail ? T.add : T.sold_out}</button>
            </div>
        </div>`;
    });
    document.getElementById('list').innerHTML = h;

    let navH = "";
    cats.forEach(c => { navH += `<div class="cat-btn" onclick="scrollToCat('${c.id}', this)">${c.name}</div>`; });
    document.getElementById('cat-nav').innerHTML = navH;

    function scrollToCat(id, btn) {
        const el = document.getElementById(id);
        if(el) {
            window.scrollTo({ top: el.offsetTop - 160, behavior: 'smooth' });
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    }

    function closeModalByBg(e, id) { if(e.target.id === id) document.getElementById(id).style.display='none'; }

    function openOpt(pid, cIdx = -1) {
        cur = P.find(x => x.id == pid);
        editIndex = cIdx;
        selectedOptIndices = [];
        addP = 0;
        
        document.getElementById('m-name').innerText = (cur['name_' + CUR_LANG] || cur.name_zh);
        let area = document.getElementById('m-opts');
        area.innerHTML = "";
        
        let opts = cur['custom_options_' + CUR_LANG] || cur.custom_options_zh || "";
        let optArr = typeof opts === 'string' ? opts.split(',').filter(x=>x.trim()) : [];
        let activeOpts = editIndex > -1 ? C[editIndex].options_zh : [];

        optArr.forEach((o, i) => {
            let parts = o.split('+'), n = parts[0].trim(), p = parts[1] ? parseInt(parts[1]) : 0;
            let d = document.createElement('div');
            d.className = 'opt-tag' + (activeOpts.includes(n) ? ' sel' : '');
            if(activeOpts.includes(n)) { selectedOptIndices.push(i); addP += p; }
            d.innerText = n + (p ? ` (+$${p})` : '');
            d.onclick = () => {
                if(d.classList.contains('sel')) {
                    d.classList.remove('sel'); addP -= p;
                    selectedOptIndices = selectedOptIndices.filter(idx => idx !== i);
                } else {
                    d.classList.add('sel'); addP += p;
                    selectedOptIndices.push(i);
                }
            };
            area.appendChild(d);
        });
        document.getElementById('m-q').value = editIndex > -1 ? C[editIndex].qty : 1;
        document.getElementById('opt-m').style.display = 'flex';
    }

    function cq(n) {
        let i = document.getElementById('m-q'), v = parseInt(i.value) || 1;
        if(v + n >= 1) i.value = v + n;
    }

    function addC() {
        let q = parseInt(document.getElementById('m-q').value) || 1;
        let oZH = (cur.custom_options_zh || "").split(',').filter(x=>x);
        let oEN = (cur.custom_options_en || cur.custom_options_zh || "").split(',').filter(x=>x);

        let data = {
            id: cur.id,
            name_zh: cur.name_zh, name_en: cur.name_en,
            unit_price: cur.price + addP,
            qty: q,
            options_zh: selectedOptIndices.map(idx => oZH[idx].split('+')[0].trim()),
            options_en: selectedOptIndices.map(idx => (oEN[idx]||oZH[idx]).split('+')[0].trim()),
            category: cur.category_zh,
            print_category: cur.print_category
        };
        if(editIndex > -1) C[editIndex] = data; else C.push(data);
        document.getElementById('opt-m').style.display = 'none';
        saveCache(); upd();
    }

    function upd() {
        let bar = document.getElementById('bar');
        if(!C.length) { bar.style.display = 'none'; return; }
        bar.style.display = 'flex';
        let foodTot = C.reduce((a, b) => a + b.unit_price * b.qty, 0);
        document.getElementById('tot').innerText = foodTot + (IS_DELIVERY ? DELIVERY_FEE : 0);
        document.getElementById('cnt').innerText = C.reduce((a, b) => a + b.qty, 0);
    }

    function showCart() {
        let h = "";
        C.forEach((i, x) => {
            let n = i['name_' + CUR_LANG] || i.name_zh;
            let o = i['options_' + CUR_LANG] || i.options_zh || [];
            h += `<div class="cart-item-row">
                <div class="cart-item-main">
                    <b>${n}</b><span>$${i.unit_price * i.qty}</span>
                </div>
                <div style="font-size:0.85em;color:#666;">${o.join(', ')}</div>
                <div class="cart-qty-sub">
                    <button onclick="C.splice(${x},1);saveCache();upd();showCart();">ğŸ—‘ï¸</button>
                    <button class="btn-edit-opt" onclick="openOpt(${i.id}, ${x})">âœï¸</button>
                    <div class="qty-ctrl" style="margin:0;gap:5px;">
                        <button onclick="C[${x}].qty=Math.max(1,C[${x}].qty-1);saveCache();upd();showCart();">-</button>
                        <span>${i.qty}</span>
                        <button onclick="C[${x}].qty+=1;saveCache();upd();showCart();">+</button>
                    </div>
                </div>
            </div>`;
        });
        document.getElementById('c-list').innerHTML = h || `<p>${T.empty_cart}</p>`;
        document.getElementById('cart-m').style.display = 'flex';
    }

    function sub() {
        if (IS_DELIVERY) {
            let foodTotal = C.reduce((a, b) => a + (b.unit_price * b.qty), 0);
            if (foodTotal < DELIVERY_MIN) return alert(`æœªæ»¿ä½æ¶ˆ $${DELIVERY_MIN}`);
            document.getElementById('tbl_input').value = 'å¤–é€';
        } else if (currentMode === 'takeout') {
            const timeVal = document.getElementById('takeout_time').value;
            if(!timeVal) return alert("è«‹é¸æ“‡å–é¤æ™‚é–“");
            document.getElementById('tbl_input').value = 'å¤–å¸¶';
            document.getElementById('scheduled_for_input').value = timeVal.replace('T', ' ');
        } else {
            let t = document.getElementById('visible_table').value;
            if(!t) return alert(T.table_placeholder);
            document.getElementById('tbl_input').value = t;
        }

        if(confirm(T.confirm_order)) {
            document.getElementById('cart_input').value = JSON.stringify(C);
            localStorage.removeItem('cart_cache');
            document.getElementById('order-form').submit();
        }
    }
    
    initCart();
    </script>
</body>
</html>
