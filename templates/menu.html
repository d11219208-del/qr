<!DOCTYPE html>
<html lang="{{ display_lang }}">
<head>
    <meta charset="UTF-8">
    <title>{{ texts['title'] }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding-bottom: 160px; background: #f8f9fa; touch-action: manipulation; font-size: 18px; }
        .header { background: white; padding: 15px; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .cat-bar { display: flex; overflow-x: auto; white-space: nowrap; padding: 10px 0; gap: 10px; scrollbar-width: none; }
        .cat-bar::-webkit-scrollbar { display: none; }
        .cat-btn { background: #f1f3f5; border: 1px solid #dee2e6; padding: 8px 18px; border-radius: 25px; font-size: 1em; color: #495057; cursor: pointer; }
        .cat-btn.active { background: #28a745; color: white; border-color: #28a745; }
        .menu-item { background: white; margin: 12px; padding: 15px; border-radius: 12px; display: flex; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; }
        .menu-img { width: 100px; height: 100px; border-radius: 10px; object-fit: cover; background: #eee; }
        .menu-info { flex: 1; padding-left: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        .menu-info b { font-size: 1.2em; }
        .add-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 20px; align-self: flex-end; font-size: 1em; font-weight: bold; }
        .sold-out { filter: grayscale(1); opacity: 0.6; pointer-events: none; }
        .sold-out-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 5px; font-size: 0.9em; font-weight: bold; z-index: 5; }
        .cart-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); display: none; flex-direction: column; box-sizing: border-box; z-index: 100; }
        .cart-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cart-buttons { display: flex; gap: 12px; }
        .btn-view-cart { background: #ff9800; color: white; border: none; flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.2em; }
        .btn-checkout { background: #28a745; color: white; border: none; flex: 1; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 1.2em; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 200; justify-content: center; align-items: flex-end; }
        .modal-c { background: white; width: 100%; padding: 25px; border-radius: 25px 25px 0 0; max-height: 85vh; overflow-y: auto; box-sizing: border-box; }
        .opt-tag { border: 1px solid #ccc; padding: 8px 15px; border-radius: 20px; margin: 5px; display: inline-block; font-size: 1.1em; }
        .opt-tag.sel { background: #e3f2fd; border-color: #2196f3; color: #2196f3; font-weight: bold; }
        .cat-header { padding: 12px 15px; font-weight: bold; font-size: 1.3em; color: #333; background: #eee; margin-top: 15px; scroll-margin-top: 160px; }
        .qty-ctrl { display: flex; align-items: center; gap: 15px; justify-content: center; margin: 20px 0; }
        .qty-ctrl button { width: 50px; height: 50px; border-radius: 25px; border: 1px solid #ddd; background: white; font-size: 1.8em; }
        .qty-input { width: 70px; text-align: center; font-size: 1.4em; border: 1px solid #ddd; padding: 8px; border-radius: 8px; }
        .cart-item-row { border-bottom: 1px solid #eee; padding: 15px 0; }
        .cart-item-main { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cart-qty-sub { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
        .btn-edit-opt { background: #e3f2fd; color: #2196f3; border: 1px solid #2196f3; padding: 6px 12px; border-radius: 8px; font-size: 0.9em; font-weight: bold; cursor: pointer; }
        
        /* Êñ∞Â¢ûÊ®£ÂºèÔºöÊ®°ÂºèÂàáÊèõËàáÂ§ñÈÄÅË°®ÂñÆ */
        .mode-switch { display: flex; background: #eee; border-radius: 10px; padding: 4px; margin-bottom: 10px; }
        .mode-btn { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .mode-btn.active { background: white; color: #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .delivery-form { display: none; background: #f0f8ff; padding: 15px; border-radius: 10px; border: 1px solid #cce5ff; }
        .df-row { margin-bottom: 10px; }
        .df-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .fee-notice { font-size: 0.9em; color: #007bff; margin-top: 5px; text-align: right; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        {% if edit_oid %}
        <div style="background:#fff3cd;padding:12px;color:#856404;text-align:center;font-weight:bold;margin-bottom:10px;border-radius:8px;">
            ‚ö†Ô∏è {{ texts['edit_notice'] or 'Ê≠£Âú®Á∑®ËºØ' }} #{{ edit_oid }} ({{ order_lang }})
        </div>
        {% endif %}
        
        <h2 style="margin:0 0 10px 0;">{{ texts['welcome'] }}</h2>

        <div class="mode-switch">
            <div class="mode-btn active" id="btn-dine" onclick="switchMode('dine_in')">üçΩÔ∏è {{ texts.get('dine_in', 'ÂÖßÁî®') }}</div>
            <div class="mode-btn" id="btn-delivery" onclick="switchMode('delivery')">üõµ {{ texts.get('delivery', 'Â§ñÈÄÅ') }}</div>
        </div>

        <div id="dine-section">
            <input type="text" id="visible_table" value="{{ table_num }}" placeholder="{{ texts['table_placeholder'] }}" 
                   style="padding:12px;width:100%;box-sizing:border-box;border:2px solid #ddd;border-radius:8px;font-size:1.2em;margin-bottom:8px;">
        </div>

        <div id="delivery-section" class="delivery-form">
            <div class="df-row"><input type="text" id="d_name" class="df-input" placeholder="Name / Á®±Âëº"></div>
            <div class="df-row"><input type="tel" id="d_phone" class="df-input" placeholder="Phone / ÈõªË©± (ÂøÖÂ°´)"></div>
            <div class="df-row"><input type="text" id="d_addr" class="df-input" placeholder="Address / Âú∞ÂùÄ (ÂøÖÂ°´)"></div>
            <div class="df-row"><input type="text" id="d_note" class="df-input" placeholder="Note / ÂÇôË®ª"></div>
            <div class="fee-notice">üõµ Delivery Fee: $<span id="disp-fee">0</span></div>
        </div>

        <div class="cat-bar" id="cat-nav"></div>
    </div>

    <div id="list"></div>

    <form id="order-form" method="POST" action="/menu">
        <input type="hidden" name="cart_data" id="cart_input">
        <input type="hidden" name="lang_input" id="lang_final_input" value="{{ order_lang }}">
        {% if edit_oid %}
        <input type="hidden" name="old_order_id" value="{{ edit_oid }}">
        {% endif %}
        
        <input type="hidden" name="table_number" id="tbl_input">
        <input type="hidden" name="order_type" id="type_input" value="dine_in">
        <input type="hidden" name="delivery_fee" id="fee_input" value="0">
        
        <input type="hidden" name="customer_name" id="h_name">
        <input type="hidden" name="customer_phone" id="h_phone">
        <input type="hidden" name="delivery_address" id="h_addr">
        <input type="hidden" name="delivery_note" id="h_note">
        
        <div class="cart-bar" id="bar">
            <div class="cart-summary">
                <div style="font-weight:bold; font-size:1.3em;">Total: $<span id="tot">0</span> (<span id="cnt">0</span>)</div>
                <label style="font-size:1em;"><input type="checkbox" name="need_receipt" checked> {{ texts['print_receipt_opt'] }}</label>
            </div>
            <div class="cart-buttons">
                <button type="button" class="btn-view-cart" onclick="showCart()">üõí {{ texts['cart_detail'] }}</button>
                <button type="button" class="btn-checkout" onclick="sub()">{{ texts['checkout'] }}</button>
            </div>
        </div>
    </form>

    <div class="modal" id="opt-m" onclick="closeModalByBg(event, 'opt-m')">
        <div class="modal-c" onclick="event.stopPropagation()">
            <h3 id="m-name" style="font-size:1.5em;margin-top:0;"></h3>
            <div id="m-opts"></div>
            <div class="qty-ctrl">
                <button onclick="cq(-1)">-</button>
                <input type="number" id="m-q" class="qty-input" value="1" min="1" inputmode="numeric">
                <button onclick="cq(1)">+</button>
            </div>
            <button id="m-confirm-btn" onclick="addC()" style="width:100%;background:#28a745;color:white;padding:18px;border:none;border-radius:15px;margin-top:10px;font-size:1.3em;font-weight:bold;">{{ texts['modal_add_cart'] }}</button>
            <button onclick="document.getElementById('opt-m').style.display='none'" style="width:100%;background:white;padding:12px;border:none;margin-top:10px;font-size:1.1em;color:#666;">{{ texts['modal_cancel'] }}</button>
        </div>
    </div>

    <div class="modal" id="cart-m" onclick="closeModalByBg(event, 'cart-m')">
        <div class="modal-c" onclick="event.stopPropagation()">
            <h2 style="margin-top:0;">{{ texts['cart_title'] }}</h2>
            <div id="c-list"></div>
            <button onclick="document.getElementById('cart-m').style.display='none'" style="width:100%;padding:15px;margin-top:20px;border:1px solid #ddd;border-radius:12px;background:#f8f9fa;font-size:1.1em;">{{ texts['close'] }}</button>
        </div>
    </div>

    <script>
    // Ë≥áÊñôÊ≥®ÂÖ•
    const P = {{ products | tojson }};
    const T = {{ texts | tojson }};
    const EDIT_OID = "{{ edit_oid or '' }}";
    const PRELOAD_CART = {{ preload_cart | safe }};
    const CUR_LANG = "{{ display_lang }}";
    const DELIVERY_FEE = {{ config.get('delivery_fee', 0) }}; // ÂæûÂæåÁ´ØËÆÄÂèñÈÅãË≤ª

    let C = [], cur = null, selectedOptIndices = [], addP = 0, editIndex = -1;
    let orderMode = 'dine_in'; // Áï∂ÂâçÊ®°Âºè: dine_in Êàñ delivery

    // --- Ê®°ÂºèÂàáÊèõÈÇèËºØ ---
    function switchMode(mode) {
        orderMode = mode;
        document.getElementById('type_input').value = mode;
        
        if(mode === 'dine_in') {
            document.getElementById('btn-dine').classList.add('active');
            document.getElementById('btn-delivery').classList.remove('active');
            document.getElementById('dine-section').style.display = 'block';
            document.getElementById('delivery-section').style.display = 'none';
        } else {
            document.getElementById('btn-dine').classList.remove('active');
            document.getElementById('btn-delivery').classList.add('active');
            document.getElementById('dine-section').style.display = 'none';
            document.getElementById('delivery-section').style.display = 'block';
            document.getElementById('disp-fee').innerText = DELIVERY_FEE;
            document.getElementById('fee_input').value = DELIVERY_FEE;
        }
        upd(); // ÈáçÊñ∞Ë®àÁÆóÁ∏ΩÂÉπ(Âê´ÈÅãË≤ª)
    }

    function saveCache() { 
        if(!EDIT_OID) localStorage.setItem('cart_cache', JSON.stringify(C)); 
    }

    function initCart() {
        if(EDIT_OID && PRELOAD_CART) {
            C = PRELOAD_CART;
        } else {
            let cached = localStorage.getItem('cart_cache');
            C = cached ? JSON.parse(cached) : [];
        }
        upd();
    }

    window.addEventListener('pageshow', function(event) {
        if (event.persisted || (C.length > 0 && !localStorage.getItem('cart_cache') && !EDIT_OID)) {
            initCart();
        }
    });

    // Ê∏≤ÊüìÁî¢ÂìÅÊ∏ÖÂñÆ
    let h = "", lastCatKey = "", cats = [];
    P.forEach(p => {
        let currentCatName = p['category_' + CUR_LANG] || p.category_zh;
        let catId = "cat-" + p.category_zh.replace(/\s+/g, '-'); 
        if(p.category_zh != lastCatKey) { 
            h += `<div class="cat-header" id="${catId}">${currentCatName}</div>`; 
            lastCatKey = p.category_zh; 
            cats.push({ id: catId, name: currentCatName });
        }
        let isAvail = p.is_available;
        let d_name = p['name_' + CUR_LANG] || p.name_zh;
        h += `<div class="menu-item ${isAvail ? '' : 'sold-out'}">
            ${isAvail ? '' : `<div class="sold-out-badge">${T.sold_out}</div>`}
            ${p.image_url ? `<img src="${p.image_url}" class="menu-img">` : ''}
            <div class="menu-info">
                <div><b>${d_name}</b><div style="color:#e91e63; font-weight:bold; font-size:1.1em;">$${p.price}</div></div>
                <button class="add-btn" onclick="openOpt(${p.id})" ${isAvail ? '' : 'disabled'}>${isAvail ? T.add : T.sold_out}</button>
            </div>
        </div>`;
    });
    document.getElementById('list').innerHTML = h;

    // Ê∏≤ÊüìÂ∞éË¶ΩÂàó
    let navH = ""; 
    cats.forEach(c => { 
        navH += `<div class="cat-btn" onclick="scrollToCat('${c.id}', this)">${c.name}</div>`; 
    });
    document.getElementById('cat-nav').innerHTML = navH;

    function scrollToCat(catId, btn) {
        const el = document.getElementById(catId);
        if(el) {
            const offset = 160;
            const bodyRect = document.body.getBoundingClientRect().top;
            const elementRect = el.getBoundingClientRect().top;
            const elementPosition = elementRect - bodyRect;
            const offsetPosition = elementPosition - offset;

            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    }

    function closeModalByBg(e, id) { if(e.target.id === id) document.getElementById(id).style.display = 'none'; }

    function openOpt(productId, cartIndex = -1) {
        cur = P.find(x => x.id == productId); 
        editIndex = cartIndex;
        selectedOptIndices = []; 
        addP = 0;
        
        document.getElementById('m-name').innerText = (editIndex > -1 ? "‚úèÔ∏è " : "") + (cur['name_' + CUR_LANG] || cur.name_zh);
        document.getElementById('m-confirm-btn').innerText = editIndex > -1 ? (T.save_changes || "üíæ ÂÑ≤Â≠ò‰øÆÊîπ") : T.modal_add_cart;
        
        let area = document.getElementById('m-opts'); 
        area.innerHTML = "";
        
        let opts = cur['custom_options_' + CUR_LANG] || cur.custom_options_zh;
        let existingOpts = editIndex > -1 ? C[editIndex].options_zh : [];
        
        opts.forEach((o, index) => {
            let parts = o.split(/[+]/); 
            let n = parts[0].trim(), p = parts.length > 1 ? parseInt(parts[1]) : 0;
            let d = document.createElement('div'); 
            d.className = 'opt-tag';
            d.innerText = n + (p ? ` (+$${p})` : '');
            
            if(editIndex > -1 && existingOpts.includes(cur.custom_options_zh[index])) {
                selectedOptIndices.push(index); 
                addP += p; 
                d.classList.add('sel');
            }
            
            d.onclick = () => {
                if(selectedOptIndices.includes(index)) {
                    selectedOptIndices = selectedOptIndices.filter(i => i != index); 
                    addP -= p; 
                    d.classList.remove('sel');
                } else {
                    selectedOptIndices.push(index); 
                    addP += p; 
                    d.classList.add('sel');
                }
            };
            area.appendChild(d);
        });
        
        document.getElementById('m-q').value = editIndex > -1 ? C[editIndex].qty : 1;
        document.getElementById('opt-m').style.display = 'flex';
        document.getElementById('cart-m').style.display = 'none';
    }

    function cq(n) {
        let input = document.getElementById('m-q'); 
        let val = parseInt(input.value) || 1;
        if(val + n >= 1) input.value = val + n;
    }

    function addC() {
        let q = parseInt(document.getElementById('m-q').value) || 1;
        let itemData = { 
            id: cur.id, 
            name_zh: cur.name_zh, name_en: cur.name_en, name_jp: cur.name_jp, name_kr: cur.name_kr, 
            unit_price: cur.price + addP, 
            qty: q, 
            options_zh: selectedOptIndices.map(idx => cur.custom_options_zh[idx]),
            options_en: selectedOptIndices.map(idx => cur.custom_options_en[idx] || cur.custom_options_zh[idx]),
            options_jp: selectedOptIndices.map(idx => cur.custom_options_jp[idx] || cur.custom_options_zh[idx]),
            options_kr: selectedOptIndices.map(idx => cur.custom_options_kr[idx] || cur.custom_options_zh[idx]),
            category: cur.category_zh, 
            print_category: cur.print_category 
        };
        
        if(editIndex > -1) C[editIndex] = itemData; else C.push(itemData);
        
        document.getElementById('opt-m').style.display = 'none'; 
        saveCache(); 
        upd(); 
        if(editIndex > -1) showCart();
    }

    function upd() {
        if(C.length) {
            document.getElementById('bar').style.display = 'flex';
            
            // Ë®àÁÆóÈ§êÈªûÁ∏ΩÈ°ç
            let foodTotal = C.reduce((a, b) => a + b.unit_price * b.qty, 0);
            
            // Â¶ÇÊûúÊòØÂ§ñÈÄÅÔºåÂä†‰∏äÈÅãË≤ª
            let finalTotal = foodTotal;
            if (orderMode === 'delivery') {
                finalTotal += DELIVERY_FEE;
            }

            document.getElementById('tot').innerText = finalTotal;
            document.getElementById('cnt').innerText = C.reduce((a, b) => a + b.qty, 0);
        } else {
            document.getElementById('bar').style.display = 'none';
        }
    }

    function updateCartQty(idx, n) {
        C[idx].qty += n; 
        if(C[idx].qty <= 0) C.splice(idx, 1);
        saveCache(); 
        showCart(); 
        upd();
    }

    function showCart() {
        let h = "";
        C.forEach((i, x) => {
            let d_name = i['name_' + CUR_LANG] || i.name_zh;
            let opts = i['options_' + CUR_LANG] || i.options_zh || [];
            let opt_str = opts.length ? `<div style="font-size:0.9em;color:#666;margin-top:4px;">(${opts.join(',')})</div>` : '';
            h += `<div class="cart-item-row">
                <div class="cart-item-main">
                    <div style="flex:1;"><b style="font-size:1.15em;">${d_name}</b>${opt_str}</div>
                    <div style="font-weight:bold;color:#e91e63;font-size:1.1em;margin-left:10px;">$${i.unit_price * i.qty}</div>
                </div>
                <div class="cart-qty-sub">
                    <button onclick="if(confirm('${T.confirm_delete || 'Delete?'}')){C.splice(${x},1);saveCache();upd();showCart();}" style="border:1px solid #ffcdd2; background:#fff5f5; border-radius:8px; padding:6px 10px; cursor:pointer; margin-right:auto;">üóëÔ∏è</button>
                    <button class="btn-edit-opt" onclick="openOpt(${i.id}, ${x})">${T.edit_options || 'Edit'}</button>
                    <div class="qty-ctrl" style="margin:0; gap:8px;">
                        <button onclick="updateCartQty(${x}, -1)" style="width:36px;height:36px;font-size:1.2em;">-</button>
                        <span style="min-width:30px;text-align:center;font-weight:bold;">${i.qty}</span>
                        <button onclick="updateCartQty(${x}, 1)" style="width:36px;height:36px;font-size:1.2em;">+</button>
                    </div>
                </div>
            </div>`;
        });
        
        // Âú®Ë≥ºÁâ©ËªäÊòéÁ¥∞‰∏≠‰πüÈ°ØÁ§∫ÈÅãË≤ªÊèêÁ§∫ (Â¶ÇÊûúÁõÆÂâçÊòØÂ§ñÈÄÅÊ®°Âºè)
        if (orderMode === 'delivery' && C.length > 0) {
            h += `<div style="text-align:right; padding:15px 0; border-top:2px solid #333; color:#007bff; font-weight:bold;">
                    Delivery Fee: $${DELIVERY_FEE}
                  </div>`;
        }

        document.getElementById('c-list').innerHTML = h || `<p style="text-align:center;">${T.empty_cart}</p>`;
        document.getElementById('cart-m').style.display = 'flex';
    }

    function sub() {
        if (orderMode === 'dine_in') {
            let t = document.getElementById('visible_table').value;
            if(!t) return alert(T.table_placeholder || 'Ë´ãËº∏ÂÖ•Ê°åËôü');
            document.getElementById('tbl_input').value = t;
        } else {
            // Â§ñÈÄÅÈ©óË≠â
            let phone = document.getElementById('d_phone').value;
            let addr = document.getElementById('d_addr').value;
            if(!phone || !addr) return alert('Phone and Address are required!\nË´ãÂ°´ÂØ´ÈõªË©±ËàáÂú∞ÂùÄ');
            
            // Â°´ÂØ´Èö±ËóèÊ¨Ñ‰Ωç
            document.getElementById('h_name').value = document.getElementById('d_name').value;
            document.getElementById('h_phone').value = phone;
            document.getElementById('h_addr').value = addr;
            document.getElementById('h_note').value = document.getElementById('d_note').value;
            // Â§ñÈÄÅÊôÇÊ°åËôüÁïôÁ©∫ÊàñÂ°´ÂØ´ÁâπÂÆöÂÄº
            document.getElementById('tbl_input').value = 'Delivery'; 
        }

        if(confirm(T.confirm_order)) {
            document.getElementById('cart_input').value = JSON.stringify(C);
            
            // Êèê‰∫§ÊàêÂäüÂæåÊ∏ÖÁ©∫Âø´Âèñ
            localStorage.removeItem('cart_cache');
            document.getElementById('order-form').submit();
        }
    }
    
    // ÂàùÂßãÂåñËºâÂÖ•
    initCart();
    </script>
</body>
</html>
