<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ³ å»šæˆ¿å‡ºå–®çœ‹æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-main: #e0e0e0;
            --accent-orange: #ff9800; --accent-green: #4caf50; --accent-red: #f44336; --accent-blue: #2196f3;
        }
        body { background: var(--bg-color); color: var(--text-main); font-family: 'Noto Sans TC', sans-serif; margin: 0; padding-bottom: 50px; }
        .header-container { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 20px; background: #252526; border-bottom: 2px solid #333;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        h1 { color: var(--accent-orange); margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 20px; }
        .card { 
            background: var(--card-bg); border-radius: 8px; overflow: hidden; border-top: 5px solid var(--accent-orange);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative;
        }
        .card.completed { border-top-color: var(--accent-green); background: #1b261b; opacity: 0.6; }
        .card.cancelled { border-top-color: var(--accent-red); background: #261b1b; opacity: 0.5; }
        .card-header { padding: 15px; background: rgba(255,255,255,0.03); border-bottom: 2px dashed #444; display: flex; justify-content: space-between; align-items: center; }
        .seq-num { font-size: 2rem; font-family: 'Roboto Mono'; font-weight: bold; color: var(--accent-orange); }
        .table-num { font-size: 1.4rem; background: #333; padding: 4px 12px; border-radius: 4px; font-weight: bold; }
        .items { padding: 15px; font-size: 1.2rem; line-height: 1.5; }
        .item-qty { color: var(--accent-orange); font-size: 1.3rem; margin-left: 10px; }
        .item-opts { font-size: 0.95rem; color: #aaa; padding-left: 10px; border-left: 2px solid #555; }
        .actions { padding: 10px; background: rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 8px; }
        .btn { border: none; border-radius: 6px; padding: 10px; color: white; font-weight: bold; cursor: pointer; text-align: center; font-size: 1rem; }
        .btn-main { background: var(--accent-green); font-size: 1.2rem; padding: 15px; width: 100%; }
        .btn-print { background: var(--accent-blue); flex: 1; }
        .btn-edit { background: #607d8b; flex: 1; }
        .btn-void { background: #d32f2f; width: 40px; }
        #status-banner { 
            background: var(--accent-red); color: white; text-align: center; padding: 12px; 
            cursor: pointer; position: sticky; top: 60px; z-index: 99;
        }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="header-container">
        <h1>ğŸ‘¨â€ğŸ³ å»šæˆ¿å‡ºå–® <span id="clock" style="font-size:0.8em; color:#888;"></span></h1>
        <div>
            <a href="/admin" style="color:white; text-decoration:none; margin-right:15px;">âš™ï¸ å¾Œå°</a>
            <a href="/kitchen/report" style="color:white; text-decoration:none;">ğŸ“Š å ±è¡¨</a>
        </div>
    </div>

    <div id="status-banner" class="pulse" onclick="enableAudio()">
        ğŸ”Š é»æ“Šæ­¤è™•å•Ÿç”¨ã€Œè‡ªå‹•åˆ—å°ã€èˆ‡ã€ŒéŸ³æ•ˆé€šçŸ¥ã€
    </div>
    
    <div id="order-grid" class="grid">
        <div style="grid-column:1/-1; text-align:center; padding:50px; color:#666;">è¼‰å…¥ä¸­...</div>
    </div>

    <audio id="notice-sound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mpeg">
    </audio>
    <div id="print-frame-container" style="display:none;"></div>

    <script>
        let lastMaxSeq = 0, isFirstLoad = true, audioUnlocked = false, printQueue = [], isPrinting = false;

        function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('zh-TW', {hour12:false}); }
        setInterval(updateClock, 1000);

        function enableAudio() { 
            audioUnlocked = true; 
            const banner = document.getElementById('status-banner');
            banner.style.background = '#4caf50';
            banner.innerText = 'âœ… è‡ªå‹•åŠŸèƒ½å·²å•Ÿç”¨';
            banner.classList.remove('pulse');
        }

        function action(url) { fetch(url).then(() => refreshOrders()); }

        async function printOrderUrl(url) {
            return new Promise(resolve => {
                const iframe = document.createElement('iframe');
                iframe.src = url;
                document.getElementById('print-frame-container').appendChild(iframe);
                iframe.onload = () => {
                    iframe.contentWindow.print();
                    setTimeout(() => { iframe.remove(); resolve(); }, 5000);
                };
            });
        }

        async function processPrintQueue() {
            if (isPrinting || printQueue.length === 0) return;
            isPrinting = true;
            await printOrderUrl('/print_order/' + printQueue.shift());
            setTimeout(() => { isPrinting = false; processPrintQueue(); }, 1000);
        }

        function refreshOrders() {
            fetch('/check_new_orders?current_seq=' + lastMaxSeq)
            .then(res => res.json())
            .then(data => {
                if (data.html) document.getElementById('order-grid').innerHTML = data.html;
                if (!isFirstLoad && data.new_ids?.length > 0 && audioUnlocked) {
                    document.getElementById('notice-sound').play();
                    data.new_ids.forEach(id => { if(!printQueue.includes(id)) printQueue.push(id); });
                    processPrintQueue();
                }
                if (data.max_seq > 0) lastMaxSeq = data.max_seq;
                isFirstLoad = false;
            });
        }
        setInterval(refreshOrders, 5000); refreshOrders();
    </script>
</body>
</html>
