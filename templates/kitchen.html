<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»šæˆ¿å‡ºé¤çœ‹æ¿</title>
    <style>
        :root {
            --pending: #fff4e5;
            --completed: #e8f5e9;
            --cancelled: #ffebee;
            --main-text: #333;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .order-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .card { 
            background: white; border-radius: 12px; border: 1px solid #ddd;
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* ç‹€æ…‹é¡è‰² */
        .card.pending { border-left: 8px solid #ff9800; background: var(--pending); }
        .card.completed { border-left: 8px solid #4caf50; background: var(--completed); opacity: 0.8; }
        .card.cancelled { border-left: 8px solid #f44336; background: var(--cancelled); opacity: 0.6; }

        .card-header { 
            padding: 12px; border-bottom: 1px dashed #ccc; 
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .seq-num { font-size: 24px; font-weight: bold; color: #d32f2f; }
        .table-num { font-size: 20px; font-weight: bold; background: #333; color: white; padding: 4px 8px; border-radius: 4px; }
        .time-stamp { font-size: 12px; color: #666; }

        .items { padding: 12px; flex-grow: 1; }
        .item-row { margin-bottom: 8px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 4px; }
        .item-name { display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; }
        .item-qty { color: #d32f2f; font-weight: bold; }
        .item-opts { font-size: 14px; color: #666; padding-left: 10px; margin-top: 2px; }

        .actions { padding: 10px; background: rgba(255,255,255,0.5); display: flex; flex-direction: column; gap: 8px; }
        .btn { 
            padding: 10px; border: none; border-radius: 6px; cursor: pointer; 
            font-size: 16px; font-weight: bold; text-align: center; text-decoration: none;
        }
        .btn-main { background: #4caf50; color: white; width: 100%; }
        .btn-group { display: flex; gap: 5px; }
        .btn-print { background: #2196f3; color: white; flex: 2; }
        .btn-edit { background: #ff9800; color: white; flex: 2; }
        .btn-void { background: #f44336; color: white; flex: 1; }

        .status-tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; color: white; }
        
        #loading-msg { text-align: center; padding: 50px; font-size: 1.5em; color: #666; }
    </style>
</head>
<body>

<header>
    <div>
        <h1 style="margin:0;">ğŸ³ å»šæˆ¿å‡ºé¤çœ‹æ¿</h1>
        <span id="update-time" style="font-size:12px; color:#888;">æ­£åœ¨é€£ç·šä¸­...</span>
    </div>
    <div class="nav-links">
        <a href="/kitchen/report" class="btn btn-print" style="padding: 8px 15px;">ğŸ“Š æ—¥çµå ±è¡¨</a>
        <button onclick="refreshOrders()" class="btn btn-edit" style="padding: 8px 15px;">ğŸ”„ ç«‹å³æ•´ç†</button>
    </div>
</header>

<div id="order-grid" class="order-grid">
    <div id="loading-msg">ğŸ½ï¸ æ­£åœ¨è¼‰å…¥è¨‚å–®...</div>
</div>

<audio id="newOrderSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<script>
    let lastMaxSeq = 0;
    const grid = document.getElementById('order-grid');
    const updateTimeText = document.getElementById('update-time');
    const audio = document.getElementById('newOrderSound');

    function refreshOrders() {
        // é‡è¦ï¼šè·¯å¾‘å¿…é ˆåŠ ä¸Š /kitchenï¼Œå°æ‡‰ app.py çš„ url_prefix
        fetch('/kitchen/check_new_orders?current_seq=' + lastMaxSeq)
            .then(response => {
                if (!response.ok) throw new Error('HTTP éŒ¯èª¤: ' + response.status);
                return response.json();
            })
            .then(data => {
                // æ›´æ–°è¨‚å–®åˆ—è¡¨
                if (data.html) {
                    grid.innerHTML = data.html;
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰æ–°è¨‚å–® ID (ç”¨æ–¼æ’­æ”¾è²éŸ³)
                if (data.new_ids && data.new_ids.length > 0) {
                    playNotification();
                    console.log("ç™¼ç¾æ–°è¨‚å–®:", data.new_ids);
                }

                lastMaxSeq = data.max_seq;
                updateTimeText.innerText = 'æœ€å¾Œæ›´æ–°: ' + new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Error:', error);
                updateTimeText.innerText = 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
            });
    }

    function action(url) {
        // é»æ“ŠæŒ‰éˆ•å¾ŒåŸ·è¡Œå¾Œç«¯æ“ä½œ
        fetch(url)
            .then(res => {
                if (res.ok) {
                    refreshOrders(); // æˆåŠŸå¾Œç«‹å³æ•´ç†é é¢
                } else {
                    alert('æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦');
                }
            })
            .catch(err => alert('é€£ç·šç™¼ç”ŸéŒ¯èª¤'));
    }

    function playNotification() {
        // æ’­æ”¾éŸ³æ•ˆä¸¦è§¸ç™¼èªéŸ³ (éƒ¨åˆ†ç€è¦½å™¨éœ€ä½¿ç”¨è€…å…ˆäº’å‹•éä¸€æ¬¡æ‰èƒ½æ’­æ”¾)
        audio.play().catch(e => console.log("éŸ³æ•ˆè‡ªå‹•æ’­æ”¾å—é˜»"));
        
        if ('speechSynthesis' in window) {
            let msg = new SpeechSynthesisUtterance("æ‚¨æœ‰æ–°è¨‚å–®");
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
        }
    }

    // æ¯ 15 ç§’è‡ªå‹•æª¢æŸ¥ä¸€æ¬¡æ–°è¨‚å–®
    setInterval(refreshOrders, 15000);

    // é é¢é–‹å•Ÿæ™‚ç«‹å³åŸ·è¡Œä¸€æ¬¡
    refreshOrders();
</script>

</body>
</html>
