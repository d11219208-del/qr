<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³å¾Œå°ç®¡ç† - é€²éšç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        :root { --primary: #9b4dca; --bg: #f4f5f7; }
        body { background: var(--bg); padding-bottom: 50px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .card { background: #fff; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* æœå°‹æ¬„ç½®é ‚æ•ˆæœ */
        .sticky-search {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg);
            padding: 15px 0;
            margin-bottom: 10px;
        }
        .sticky-search input { 
            background: #fff; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }

        .btn-full { width: 100%; } 
        .btn-sm { padding: 0 10px; height: 28px; line-height: 26px; font-size: 1.1rem; }
        .status-on { background: #e6ffed; color: #28a745; border-color: #b7eb8f; }
        .status-off { background: #fff1f0; color: #f5222d; border-color: #ffa39e; }
        
        .alert { padding: 12px; background: #e6f7ff; color: #0050b3; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid #1890ff; }
        .lang-tag { font-size: 0.7em; background: #eee; padding: 2px 5px; border-radius: 4px; margin-right: 3px; color: #666; }
        .handle { cursor: grab; color: #ccc; font-size: 20px; }
        
        /* è¡¨æ ¼å„ªåŒ– */
        table { border-collapse: collapse; }
        tr.product-row:hover { background: #fafafa; }
        .prod-detail { font-size: 0.85em; color: #888; margin-top: 4px; }
        
        .flex-actions { display: flex; gap: 10px; align-items: center; }
        .import-box { border: 2px dashed #ccc; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>ğŸ´ é¤å»³ç³»çµ±å¾Œå°</h2>
            <div>
                <a href="/kitchen" class="button button-outline">ğŸ‘¨â€ğŸ³ é€²å…¥å»šæˆ¿çœ‹æ¿</a>
            </div>
        </div>
        
        {% if msg %}
        <div id="status-msg" class="alert">{{ msg }}</div>
        {% endif %}

        <div class="card">
            <h4>âš™ï¸ ç³»çµ±èˆ‡å ±è¡¨è¨­å®š</h4>
            <form method="POST" action="/admin">
                <div class="row">
                    <div class="column"><label>æ”¶ä»¶ Email</label><input type="email" name="report_email" value="{{ config.get('report_email','') }}" placeholder="æ¥æ”¶æ¯æ—¥å ±è¡¨"></div>
                    <div class="column"><label>Resend API Key</label><input type="password" name="resend_api_key" value="{{ config.get('resend_api_key','') }}" placeholder="re_..."></div>
                </div>
                <button type="submit" name="action" value="save_settings">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button type="submit" name="action" value="test_email" class="button button-outline">ğŸ§ª æ¸¬è©¦ç™¼é€</button>
                <button type="submit" name="action" value="send_report_now" class="button button-outline" style="float: right;">ğŸ“Š ç«‹å³ç™¼é€ä»Šæ—¥å ±è¡¨</button>
            </form>
        </div>

        <div class="card">
            <h4>â• æ–°å¢/ç·¨è¼¯ç”¢å“</h4>
            <form method="POST" action="/admin">
                <input type="hidden" name="action" value="add_product">
                <div class="row">
                    <div class="column column-40">
                        <label>å“é …åç¨± (ç¹ä¸­)</label>
                        <input type="text" name="name" required placeholder="ä¾‹å¦‚ï¼šç´…ç‡’ç‰›è‚‰éºµ">
                    </div>
                    <div class="column">
                        <label>åƒ¹æ ¼</label>
                        <input type="number" name="price" required placeholder="100">
                    </div>
                    <div class="column">
                        <label>åˆ†é¡</label>
                        <input type="text" name="category" placeholder="ä¸»é£Ÿ">
                    </div>
                </div>
                
                <div class="row">
                    <div class="column"><input type="text" name="name_en" placeholder="English Name (EN)"></div>
                    <div class="column"><input type="text" name="name_jp" placeholder="æ—¥æœ¬èªåç§° (JP)"></div>
                    <div class="column"><input type="text" name="name_kr" placeholder="í•œêµ­ì–´ ì´ë¦„ (KR)"></div>
                </div>

                <div class="row">
                    <div class="column column-75"><input type="text" name="image_url" placeholder="åœ–ç‰‡é€£çµ (URL)"></div>
                    <div class="column"><button type="submit" class="button btn-full">ğŸš€ æäº¤ç”¢å“</button></div>
                </div>
            </form>
        </div>

        <div class="card">
            <h4>ğŸ“‚ æ‰¹æ¬¡ç®¡ç† (Excel)</h4>
            <div class="row">
                <div class="column">
                    <div class="import-box">
                        <form method="POST" action="/admin/import_menu" enctype="multipart/form-data">
                            <label>åŒ¯å…¥èœå–® (.xlsx)</label>
                            <input type="file" name="excel_file" accept=".xlsx" required>
                            <button type="submit" class="button button-small">ğŸ“¥ é–‹å§‹åŒ¯å…¥</button>
                        </form>
                    </div>
                </div>
                <div class="column">
                    <div class="import-box" style="border-style: solid;">
                        <label>å‚™ä»½æ•¸æ“š</label><br>
                        <a href="/admin/export_menu" class="button button-outline btn-full">ğŸ“¤ åŒ¯å‡ºç›®å‰èœå–® Excel</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="sticky-search">
            <input type="text" id="productSearch" placeholder="ğŸ” è¼¸å…¥é—œéµå­—æœå°‹å“é … (åç¨±ã€åˆ†é¡ã€èªè¨€)...">
        </div>

        <div class="card">
            <h4>ğŸ“‹ èœå–®æ¸…å–® (æ‹–æ›³å¯æ’åº)</h4>
            <table>
                <thead>
                    <tr>
                        <th width="40"></th>
                        <th>å“é …è©³æƒ…</th>
                        <th width="100">åƒ¹æ ¼</th>
                        <th width="120">ç‹€æ…‹</th>
                        <th width="120">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="menu-list">
                    {% for p in prods %}
                    <tr data-id="{{ p[0] }}" class="product-row">
                        <td class="handle">â˜°</td>
                        <td>
                            <div class="prod-name"><b>{{ p[1] }}</b></div>
                            <div class="prod-detail">
                                <span class="lang-tag">EN</span>{{ p[8] or '-' }} | 
                                <span class="lang-tag">JP</span>{{ p[9] or '-' }} | 
                                <span class="lang-tag">KR</span>{{ p[10] or '-' }}
                            </div>
                            <div class="prod-detail">åˆ†é¡: {{ p[3] }} | åˆ—å°: {{ p[5] }}</div>
                        </td>
                        <td><b>${{ p[2] }}</b></td>
                        <td>
                            <button onclick="toggleProduct({{ p[0] }}, this)" 
                                    class="btn-sm {{ 'status-on' if p[4] else 'status-off' }}">
                                {{ 'ä¸Šæ¶ä¸­' if p[4] else 'å·²ä¸‹æ¶' }}
                            </button>
                        </td>
                        <td class="flex-actions">
                            <a href="/admin/edit_product/{{ p[0] }}" class="button button-clear">âœ ç·¨è¼¯</a>
                            <a href="/admin/delete_product/{{ p[0] }}" class="button button-clear" style="color:red;" onclick="return confirm('ç¢ºå®šåˆªé™¤å“é …?')">âœ–</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div style="margin-top: 30px; text-align: right;">
                <a href="/admin/reset_menu" class="button" style="background:#ff4d4f; border-color:#ff4d4f;" onclick="return confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰ç”¢å“æ•¸æ“šï¼')">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰èœå–®</a>
            </div>
        </div>
    </div>

    <script>
        // 1. è‡ªå‹•éš±è—è¨Šæ¯
        const msgBox = document.getElementById('status-msg');
        if(msgBox) { setTimeout(()=> msgBox.style.opacity='0', 2500); }
        
        // 2. åˆ‡æ›ä¸Šä¸‹æ¶ (AJAX)
        function toggleProduct(pid, btn) {
            fetch('/admin/toggle_product/' + pid, {method:'POST'})
            .then(r=>r.json()).then(d=>{
                if(d.status==='success') {
                    btn.className = d.is_available ? 'btn-sm status-on' : 'btn-sm status-off';
                    btn.innerText = d.is_available ? 'ä¸Šæ¶ä¸­' : 'å·²ä¸‹æ¶';
                }
            });
        }

        // 3. é€²éšæœå°‹åŠŸèƒ½ (æ”¯æ´å¤šåœ‹èªè¨€æœå°‹)
        document.getElementById('productSearch').addEventListener('input', e=>{
            let v = e.target.value.toLowerCase();
            document.querySelectorAll('.product-row').forEach(r=>{
                const text = r.innerText.toLowerCase();
                r.style.display = text.includes(v) ? '' : 'none';
            });
        });

        // 4. æ‹–æ›³æ’åºåŒæ­¥åˆ°è³‡æ–™åº«
        Sortable.create(document.getElementById('menu-list'), {
            handle: '.handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function() {
                let order = Array.from(document.querySelectorAll('#menu-list tr')).map(r=>r.getAttribute('data-id'));
                fetch('/admin/reorder_products', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({order:order})
                });
            }
        });
    </script>
</body>
</html>
